<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Batch Processing - Spot Instances</title>
    
    <!-- 1. Tailwind CSS (Para el diseño idéntico sin build steps) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Lucide Icons (Para los iconos) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Estilos personalizados para scrollbar y animaciones extra -->
    <style>
        body {
            background-color: #0f172a; /* Slate 900 */
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        /* Animaciones para entradas de logs y elementos */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-zoom-in {
            animation: zoomIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="text-slate-100 p-4 md:p-8 min-h-screen">

    <div class="max-w-6xl mx-auto">
        
        <!-- HEADER -->
        <header class="mb-10 text-center">
            <div class="inline-flex items-center gap-2 bg-indigo-900/30 text-indigo-300 px-4 py-1 rounded-full text-sm font-semibold mb-4 border border-indigo-700/50">
                <i data-lucide="cloud-lightning" width="16"></i> Arquitectura Cloud Eficiente
            </div>
            <h1 class="text-3xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400 mb-4">
                Escalado Horizontal Elástico con Instancias Spot
            </h1>
            <p class="text-slate-400 max-w-2xl mx-auto text-lg">
                Procesamiento batch acelerado 10x con 90% de descuento usando AWS Batch, SQS y Contenedores efímeros.
            </p>
        </header>

        <!-- MAIN GRID -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
            
            <!-- LEFT COLUMN: CONTROLS & LOGS -->
            <div class="space-y-6">
                
                <!-- CONTROL CARD -->
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 shadow-lg border-l-4 border-l-blue-500">
                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="refresh-cw" class="text-blue-400" width="20"></i> Simulador de Batch
                    </h3>
                    
                    <div class="space-y-4 mb-6">
                        <!-- TIME DISPLAY -->
                        <div class="flex justify-between items-center bg-slate-900/50 p-3 rounded">
                            <span class="text-sm text-slate-400">Hora Simulada</span>
                            <span id="timeDisplay" class="font-mono text-xl text-yellow-400">02:00</span>
                        </div>
                        
                        <!-- PROGRESS BAR -->
                        <div class="w-full">
                            <div class="flex justify-between text-xs mb-1 text-slate-400">
                                <span>Progreso del Dataset</span>
                                <span id="progressText">0%</span>
                            </div>
                            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div id="progressBar" class="h-full transition-all duration-500 bg-emerald-500" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- COUNTERS -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-900/50 p-2 rounded text-center">
                                <div class="text-xs text-slate-400">Instancias Activas</div>
                                <div id="activeInstancesDisplay" class="text-2xl font-bold text-blue-400">0</div>
                                <div class="text-[10px] text-slate-500">Spot Workers</div>
                            </div>
                            <div class="bg-slate-900/50 p-2 rounded text-center">
                                <div class="text-xs text-slate-400">Cola SQS</div>
                                <div id="queueCountDisplay" class="text-2xl font-bold text-orange-400">0</div>
                                <div class="text-[10px] text-slate-500">Mensajes Pendientes</div>
                            </div>
                        </div>
                    </div>

                    <!-- ACTION BUTTON -->
                    <button id="actionBtn" onclick="toggleSimulation()" class="w-full py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-all bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/20">
                        Iniciar Carga Nocturna <i data-lucide="power" width="18"></i>
                    </button>
                </div>

                <!-- LOGS CARD -->
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 shadow-lg">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3 flex justify-between">
                        Logs de Ejecución
                        <span class="text-[10px] font-normal text-slate-500">(Scroll para ver más)</span>
                    </h3>
                    <div id="logsContainer" class="h-48 overflow-y-auto relative font-mono text-xs space-y-2 pr-2 custom-scrollbar">
                        <div class="text-slate-600 italic text-center mt-10" id="emptyLogsMsg">Esperando inicio...</div>
                        <!-- Logs will be injected here -->
                    </div>
                </div>
            </div>

            <!-- CENTER/RIGHT COLUMN: VISUAL DIAGRAM -->
            <div class="lg:col-span-2 relative bg-slate-950 rounded-xl border border-slate-800 overflow-hidden flex flex-col items-center justify-center p-8 min-h-[500px]">
                <!-- Background Grid Pattern -->
                <div class="absolute inset-0 bg-[linear-gradient(to_right,#1e293b_1px,transparent_1px),linear-gradient(to_bottom,#1e293b_1px,transparent_1px)] bg-[size:40px_40px] opacity-20"></div>

                <div class="relative z-10 w-full flex justify-between items-center gap-4">
                    
                    <!-- 1. DATA LAKE -->
                    <div class="flex flex-col items-center gap-2">
                        <div class="w-20 h-20 bg-indigo-900/40 border-2 border-indigo-500 rounded-lg flex items-center justify-center shadow-[0_0_20px_rgba(99,102,241,0.3)]">
                            <i data-lucide="database" class="text-indigo-400" width="40" height="40"></i>
                        </div>
                        <span class="px-2 py-1 text-xs font-mono border rounded bg-blue-900/50 text-blue-200 border-blue-700">Data Lake / S3</span>
                        <div class="text-xs text-slate-500 max-w-[100px] text-center">Dataset masivo particionado</div>
                    </div>

                    <!-- ARROW 1 & ANIMATION -->
                    <div class="flex-1 h-2 relative mx-2 bg-slate-800 rounded-full">
                        <div id="chunksAnimation" class="hidden">
                            <div class="absolute top-1/2 -translate-y-1/2 w-3 h-3 bg-yellow-400 rounded-sm animate-ping" style="left: 25%; animation-duration: 1s;"></div>
                            <div class="absolute top-1/2 -translate-y-1/2 w-3 h-3 bg-yellow-400 rounded-sm animate-ping" style="left: 50%; animation-duration: 1s; animation-delay: 0.2s;"></div>
                            <div class="absolute top-1/2 -translate-y-1/2 w-3 h-3 bg-yellow-400 rounded-sm animate-ping" style="left: 75%; animation-duration: 1s; animation-delay: 0.4s;"></div>
                        </div>
                        <i data-lucide="arrow-right" class="absolute -right-2 top-1/2 -translate-y-1/2 text-slate-600" width="16"></i>
                    </div>

                    <!-- 2. SQS -->
                    <div class="flex flex-col items-center gap-2 relative">
                        <div class="w-24 h-24 bg-orange-900/30 border-2 border-orange-500 rounded-lg flex flex-col items-center justify-center relative">
                            <i data-lucide="layers" class="text-orange-400 mb-1" width="40" height="40"></i>
                            <span id="sqsCountBadge" class="text-2xl font-bold text-white">0</span>
                        </div>
                        <span class="px-2 py-1 text-xs font-mono border rounded bg-orange-900/50 text-orange-200 border-orange-700">Amazon SQS</span>
                        <div class="text-xs text-slate-500 max-w-[100px] text-center">Buffer de trabajos desacoplado</div>
                    </div>

                    <!-- ARROW 2 & PULSE -->
                    <div class="flex-1 h-2 relative mx-2 bg-slate-800 rounded-full">
                        <div id="processingPulse" class="absolute inset-0 bg-blue-500/20 animate-pulse rounded-full hidden"></div>
                        <i data-lucide="arrow-right" class="absolute -right-2 top-1/2 -translate-y-1/2 text-slate-600" width="16"></i>
                    </div>

                    <!-- 3. BATCH COMPUTE -->
                    <div class="flex flex-col items-center gap-2 w-1/3">
                        <div class="w-full min-h-[160px] bg-slate-900/80 border-2 border-dashed border-emerald-600/50 rounded-xl p-4 relative transition-all duration-500">
                            <div class="absolute -top-3 left-4 bg-slate-950 px-2 text-emerald-500 text-xs font-bold border border-emerald-900 rounded">
                                AWS Batch (Spot Fleet)
                            </div>
                            
                            <!-- GRID DE INSTANCIAS (Dynamic) -->
                            <div id="instancesGrid" class="grid grid-cols-4 gap-2 mt-2">
                                <!-- Las instancias se inyectan aquí con JS -->
                                <div class="col-span-4 text-center text-slate-600 text-sm mt-8 flex flex-col items-center">
                                    <i data-lucide="power" class="mb-2 opacity-50" width="24"></i>
                                    <span>Sistema en Espera (Costo $0)</span>
                                </div>
                            </div>
                        </div>
                        <span class="px-2 py-1 text-xs font-mono border rounded bg-green-900/50 text-green-200 border-green-700">Spot Capacity Optimized</span>
                    </div>

                </div>

                <!-- RESULTADOS -->
                <div class="absolute bottom-4 right-8 flex items-center gap-2 opacity-50">
                    <div class="text-xs text-slate-500">Resultados</div>
                    <i data-lucide="arrow-right" class="text-slate-600" width="12"></i>
                    <i data-lucide="database" class="text-blue-400" width="16"></i>
                    <span class="text-sm font-mono text-emerald-400">+<span id="processedCount">0</span> processed</span>
                </div>
            </div>
        </div>

        <!-- LOGIC & COSTS SECTION -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <!-- IMPLEMENTATION STEPS -->
            <div class="space-y-4">
                <h2 class="text-2xl font-bold text-white mb-6">Implementación Paso a Paso</h2>
                
                <div class="group bg-slate-800 p-4 rounded-lg border-l-4 border-indigo-500 hover:bg-slate-750 transition-colors">
                    <h3 class="font-bold text-lg text-indigo-300 flex items-center gap-2">
                        1. División de Datos (Chunking)
                    </h3>
                    <p class="text-slate-400 text-sm mt-2">En lugar de procesar un archivo gigante, partimos millones de registros en pequeños JSONs. Esto permite paralelismo masivo.</p>
                </div>
                <div class="group bg-slate-800 p-4 rounded-lg border-l-4 border-orange-500 hover:bg-slate-750 transition-colors">
                    <h3 class="font-bold text-lg text-orange-300 flex items-center gap-2">
                        2. Configuración de Cola SQS
                    </h3>
                    <p class="text-slate-400 text-sm mt-2">SQS actúa como un buffer elástico que absorbe picos de carga y permite desacoplar la generación del procesamiento.</p>
                </div>
                <div class="group bg-slate-800 p-4 rounded-lg border-l-4 border-emerald-500 hover:bg-slate-750 transition-colors">
                    <h3 class="font-bold text-lg text-emerald-300 flex items-center gap-2">
                        3. AWS Batch & Spot Strategy
                    </h3>
                    <p class="text-slate-400 text-sm mt-2">Compute Environment con estrategia <code>SPOT_CAPACITY_OPTIMIZED</code>. Diversifica tipos de instancias (C5, M5) para disponibilidad.</p>
                </div>
                <div class="group bg-slate-800 p-4 rounded-lg border-l-4 border-red-500 hover:bg-slate-750 transition-colors">
                    <h3 class="font-bold text-lg text-red-300 flex items-center gap-2">
                        4. Manejo de Fallos (Resiliencia)
                    </h3>
                    <p class="text-slate-400 text-sm mt-2">Si Spot es reclamada, el job falla. Configura <strong>Automatic Retries</strong> y checkpoints en S3 para reanudar sin pérdidas.</p>
                </div>
            </div>

            <!-- COST ANALYSIS -->
            <div class="space-y-6">
                <h2 class="text-2xl font-bold text-white mb-6">Análisis de Beneficios y Costos</h2>
                
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 shadow-lg">
                    <div class="flex justify-between items-end mb-4">
                        <div>
                            <div class="text-sm text-slate-400">Costo Estimado (Simulación)</div>
                            <div class="text-3xl font-bold text-emerald-400">$<span id="costSpot">0.00</span></div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-slate-400">Costo On-Demand (Equivalente)</div>
                            <div class="text-xl font-bold text-slate-500 line-through decoration-red-500">
                                $<span id="costOnDemand">0.00</span>
                            </div>
                            <span class="px-2 py-1 text-xs font-mono border rounded bg-green-900/50 text-green-200 border-green-700">90% Ahorro</span>
                        </div>
                    </div>

                    <!-- GRAPH -->
                    <div class="w-full bg-slate-900 rounded-lg p-4 mb-4">
                        <div class="flex items-end h-32 gap-4 pb-2">
                            <div class="flex-1 flex flex-col justify-end gap-2 h-full">
                                <div class="w-full bg-slate-700 h-full rounded-t opacity-30 relative group flex-1">
                                    <div class="absolute bottom-full w-full text-center text-xs mb-1 hidden group-hover:block whitespace-nowrap">Costo Fijo</div>
                                </div>
                                <div class="text-center text-xs text-slate-500">On-Demand</div>
                            </div>
                            <div class="flex-1 flex flex-col justify-end gap-2 h-full">
                                <div class="w-full bg-emerald-600/80 h-[10%] rounded-t animate-pulse relative group">
                                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 w-max text-center text-xs mb-1 text-emerald-400">Solo paga por uso</div>
                                </div>
                                <div class="text-center text-xs text-emerald-400">Spot Batch</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BENEFITS GRID -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-800 p-4 rounded-lg">
                        <i data-lucide="clock" class="text-blue-400 mb-2"></i>
                        <h4 class="font-bold text-slate-200">Velocidad 10x</h4>
                        <p class="text-xs text-slate-400 mt-1">Paralelización masiva reduce procesos de horas a minutos.</p>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-lg">
                        <i data-lucide="dollar-sign" class="text-emerald-400 mb-2"></i>
                        <h4 class="font-bold text-slate-200">Costo Cero Idle</h4>
                        <p class="text-xs text-slate-400 mt-1">Al terminar la cola, todo se apaga. No hay servidores "zombie".</p>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-lg">
                        <i data-lucide="alert-triangle" class="text-orange-400 mb-2"></i>
                        <h4 class="font-bold text-slate-200">Tolerancia a Fallos</h4>
                        <p class="text-xs text-slate-400 mt-1">Arquitectura diseñada para que los nodos puedan morir sin perder datos.</p>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-lg">
                        <i data-lucide="check-circle" class="text-purple-400 mb-2"></i>
                        <h4 class="font-bold text-slate-200">Servidor Principal Libre</h4>
                        <p class="text-xs text-slate-400 mt-1">La carga pesada ocurre fuera de tu base de datos transaccional.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONCLUSION CARD -->
        <div class="mb-12 bg-slate-800 border border-slate-700 rounded-xl p-6 shadow-lg border-t-4 border-t-emerald-500 bg-gradient-to-br from-slate-800 to-slate-900">
            <div class="flex items-start gap-4">
                <div class="p-3 bg-emerald-900/30 rounded-lg hidden sm:block">
                    <i data-lucide="lightbulb" class="text-emerald-400" width="32" height="32"></i>
                </div>
                <div>
                   <h2 class="text-2xl font-bold text-white mb-4">Conclusión: Solución al Caso de Estudio</h2>
                   <p class="text-slate-300 leading-relaxed text-lg">
                     Esta arquitectura es la respuesta ideal para el problema de <strong>"Trabajo batch pesado diario"</strong>. 
                     Al mover la carga a un entorno efímero y distribuido, liberamos al servidor principal de la saturación del 100% de CPU, 
                     protegiendo otras cargas críticas. El escalado horizontal reduce drásticamente la duración del análisis (aceleración), 
                     mientras que el uso de instancias Spot asegura que esta velocidad extra no implique costos fijos, pagando solo una fracción 
                     del precio estándar.
                   </p>
                </div>
            </div>
        </div>

    </div>

    <!-- LOGIC SCRIPT -->
    <script>
        // Inicializar Iconos
        lucide.createIcons();

        // Estado Global
        let simulationState = 'idle'; // idle, running, interrupted, completed
        let queueCount = 0;
        let activeInstances = 0;
        let completedJobs = 0;
        let costAccumulated = 0;
        let timeOfDay = 18.0;
        let intervalId = null;

        // Configuración
        const TOTAL_JOBS = 50;
        const MAX_INSTANCES = 8;
        const SPOT_PRICE = 0.04;
        const ONDEMAND_PRICE = 0.40;
        const TIME_STEP_HOURS = 0.1;

        // Referencias DOM
        const els = {
            time: document.getElementById('timeDisplay'),
            progressText: document.getElementById('progressText'),
            progressBar: document.getElementById('progressBar'),
            activeInstances: document.getElementById('activeInstancesDisplay'),
            queueCount: document.getElementById('queueCountDisplay'),
            logs: document.getElementById('logsContainer'),
            btn: document.getElementById('actionBtn'),
            chunksAnim: document.getElementById('chunksAnimation'),
            pulseAnim: document.getElementById('processingPulse'),
            instancesGrid: document.getElementById('instancesGrid'),
            processedCount: document.getElementById('processedCount'),
            costSpot: document.getElementById('costSpot'),
            costOnDemand: document.getElementById('costOnDemand'),
            emptyLogs: document.getElementById('emptyLogsMsg')
        };

        function addLog(msg, type = 'info') {
            if (els.emptyLogs) els.emptyLogs.style.display = 'none';

            const div = document.createElement('div');
            
            // Clases base
            let classes = "p-2 rounded border-l-2 animate-fade-in font-mono text-xs mb-2 ";
            
            // Colores según tipo
            if (type === 'error') classes += "bg-red-900/20 border-red-500 text-red-200";
            else if (type === 'warning') classes += "bg-orange-900/20 border-orange-500 text-orange-200";
            else if (type === 'success') classes += "bg-green-900/20 border-green-500 text-green-200";
            else classes += "bg-slate-800 border-slate-600 text-slate-300";

            div.className = classes;
            const timeStr = new Date().toLocaleTimeString();
            div.innerHTML = `<span class="opacity-50 mr-2">[${timeStr}]</span> ${msg}`;
            
            // Insertar al inicio (Top)
            els.logs.prepend(div);
            // Scroll al top
            els.logs.scrollTop = 0;
        }

        function updateUI() {
            // Tiempo
            const hours = Math.floor(timeOfDay);
            const minutes = Math.floor((timeOfDay % 1) * 60);
            els.time.innerText = `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}`;

            // Progreso
            const pct = Math.round(Math.min(100, (completedJobs / TOTAL_JOBS) * 100));
            els.progressText.innerText = `${pct}%`;
            els.progressBar.style.width = `${pct}%`;

            // Contadores
            els.activeInstances.innerText = activeInstances;
            els.queueCount.innerText = queueCount;
            els.processedCount.innerText = completedJobs;

            // Costos
            els.costSpot.innerText = costAccumulated.toFixed(2);
            els.costOnDemand.innerText = (costAccumulated * (ONDEMAND_PRICE/SPOT_PRICE)).toFixed(2);

            // Animaciones
            if (queueCount > 0 && simulationState === 'running') {
                els.chunksAnim.classList.remove('hidden');
            } else {
                els.chunksAnim.classList.add('hidden');
            }

            if (activeInstances > 0 && queueCount > 0) {
                els.pulseAnim.classList.remove('hidden');
            } else {
                els.pulseAnim.classList.add('hidden');
            }

            // Grid de Instancias
            renderInstancesGrid();
        }

        function renderInstancesGrid() {
            els.instancesGrid.innerHTML = '';
            
            if (activeInstances === 0) {
                els.instancesGrid.innerHTML = `
                    <div class="col-span-4 text-center text-slate-600 text-sm mt-8 flex flex-col items-center">
                        <i data-lucide="power" class="mb-2 opacity-50" width="24"></i>
                        <span>Sistema en Espera (Costo $0)</span>
                    </div>
                `;
                lucide.createIcons(); // Re-render icon
                return;
            }

            for (let i = 0; i < activeInstances; i++) {
                const div = document.createElement('div');
                div.className = "animate-zoom-in";
                div.innerHTML = `
                    <div class="w-10 h-10 bg-emerald-900/40 border border-emerald-500 rounded flex items-center justify-center relative group">
                        <i data-lucide="cpu" class="text-emerald-400" width="20"></i>
                        <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_10px_#22c55e]"></div>
                        <div class="absolute bottom-full mb-2 hidden group-hover:block bg-black text-[10px] p-1 rounded whitespace-nowrap z-20">Spot C5.large</div>
                    </div>
                `;
                els.instancesGrid.appendChild(div);
            }
            lucide.createIcons(); // Importante para que aparezcan los iconos nuevos
        }

        function toggleSimulation() {
            if (simulationState === 'running') return; // Ya corre

            // Reset
            simulationState = 'running';
            queueCount = TOTAL_JOBS;
            completedJobs = 0;
            costAccumulated = 0;
            activeInstances = 0;
            timeOfDay = 2.0; // 2 AM
            
            // UI Reset
            els.logs.innerHTML = ''; // Limpiar logs
            els.btn.classList.add('bg-slate-700', 'text-slate-500', 'cursor-not-allowed');
            els.btn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
            els.btn.innerText = "Procesando...";
            
            addLog("Inicio de Batch: Dataset dividido en chunks", "info");
            addLog("Enviando mensajes a Amazon SQS...", "info");
            updateUI();

            // Loop
            if (intervalId) clearInterval(intervalId);
            intervalId = setInterval(gameLoop, 800);
        }

        function gameLoop() {
            if (simulationState !== 'running') return;

            // 1. Escalado
            if (queueCount > 0 && activeInstances < MAX_INSTANCES) {
                if (Math.random() > 0.3) {
                    activeInstances++;
                    addLog("Escalando: Nueva instancia Spot C5.large lanzada", "success");
                }
            }

            // 2. Desescalado
            if (queueCount === 0 && activeInstances > 0) {
                activeInstances--;
                if (activeInstances === 1) { // Cuando baja a la última
                     // Fin
                }
                if (activeInstances === 0) {
                    simulationState = 'completed';
                    addLog("Cola vacía. Apagando instancias para ahorrar.", "success");
                    els.btn.classList.remove('bg-slate-700', 'text-slate-500', 'cursor-not-allowed');
                    els.btn.classList.add('bg-blue-600', 'hover:bg-blue-500');
                    els.btn.innerHTML = `Reiniciar Simulación <i data-lucide="power" width="18"></i>`;
                    lucide.createIcons();
                    clearInterval(intervalId);
                }
            }

            // 3. Procesamiento
            if (activeInstances > 0 && queueCount > 0) {
                const processedInTick = Math.min(queueCount, activeInstances);
                
                // Simular Interrupción (12%)
                const randomInterruption = Math.random() < 0.12;

                if (randomInterruption && activeInstances > 2) {
                    addLog("ALERTA: Instancia Spot reclamada por AWS", "error");
                    addLog("Retry: Checkpoint detectado. Re-encolando job...", "warning");
                    activeInstances--;
                    queueCount += 2; // Penalización
                    completedJobs = Math.max(0, completedJobs - 2);
                } else {
                    queueCount -= processedInTick;
                    completedJobs += processedInTick;
                    
                    // Costo
                    const costForThisTick = activeInstances * SPOT_PRICE * TIME_STEP_HOURS;
                    costAccumulated += costForThisTick;
                }
            }

            // Tiempo
            timeOfDay += TIME_STEP_HOURS;
            if (timeOfDay >= 24) timeOfDay = 0;

            updateUI();
        }
    </script>
</body>
</html>
